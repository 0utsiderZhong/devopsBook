# 七层负载均衡技术发展趋势

天生有损的网络的网络越来越难以运维，而且，自动扩缩容、容器调度器等技术的崛起，意味着通过静态文件配置静态 IP 的方式早就过时，系统不仅使网络更加频繁，而且使用的方式越来越动态，这就需要负载均衡器提供更多现代化的功能。把这些功能统一前移某一层独立支持，实现 API Gateway as a Service，让各个服务直接接入，在管理平台上管理，可视化配置等等, 这样就实现了一个全局的视图统一管理这些功能，这就是7层负载均衡的升级 -- 网关（API Gateway）。

API Gateway 在业内已经有非常多的成熟开源方案，如果按实现语言以及成熟度来讲，主流有以下的几个方案：

|语言|网关|特点|
|:--|:--|:--|
|Nginx + LuaJIT|OpenResty| 原始 Web 开发平台 |
|Nginx + Lua| Kong| 社区活跃、成熟度高、Postgres 存储、二次开发成本高 |
|Nginx + Lua| Apache/APISIX | 云原生化、使用 etcd 存储、性能高、二次开发成本低|
|Java|Spring Cloud Alibaba| Spring Cloud 生态、社区成熟度高、国内应用广泛|


1. 协议支持

现代 L7 负载均衡器正在显式添加对更多协议的支持。负载均衡器对应用层协议了解的越多， 就可以处理越多更复杂的事情，包括观测输出、高级负载均衡和路由等等。例如，在写作本文时，Envoy 显式支持如下 L7 协议的解析和路由：HTTP/1、HTTP/2、gRPC、Redis、MongoDB、DynamoDB。

2. 动态配置

如前面描述的，分布式系统越来越动态的本质需要同时在两方面做投资：动态和响应式控制。 Istio 即使这种系统的一个例子

3. 高级负载均衡

L7LB 现在一般都内置高级负载均衡的特性，例如超时、重试、限速、熔断、流量镜像（shadowing）、缓存、基于内容的路由等等

4. 可观测性

前面在介绍通用负载均衡器特性时讲到，随着部署的系统越来越动态，debug 也越来越困难。 健壮的协议相关的（protocol specific）可观测性输出可能是现代 L7LB 提供的最重要的特性。 输出数值统计、分布式跟踪以及自定义日志等功能现在几乎是 L7 负载均衡解决方案的标配。

5. 可扩展性

现代 L7LB 的用户常常希望能够轻松地对它扩展以添加自定义的功能。这可以通过 编写可插拔的过滤器，然后加载到负载均衡器实现。一些负载均衡器还支持脚本编程， 典型的是通过 Lua。

6. 容错

前面介绍了很多 L4LB 容错的内容。那么 L7LB 的容错又如何呢？通常来说，我们认为 L7LB 是易消耗的和无状态的（expendable and stateless）。基于通用软件使得 L7LB 可以轻松地实现水平扩展。

总体来说，不管是在 L4 还是在 L7 负载均衡领域，业界都在从 HA pair 架构转向基于 一致性哈希的水平可扩展架构。