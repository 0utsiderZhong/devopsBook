# 七层负载均衡 

七层负载均衡更贴近于服务，可以识别应用层协议，比如使用 Nginx 七层负载均衡方案可以通过对 HTTP 头、URL、Cookie 做复杂的逻辑处理，实现更灵活的控制。

互联网技术架构中，通常 7 层负载均衡的核心是 Nginx。配合 Lua，如 OpenResty，能扩展实现功能丰富且性能较高的网关方案。Nginx 使用 epoll 以及 LuaJIT 相关的技术实现高并发的支撑，可以实现 C10k 的并发处理，一般用 qps(请求/秒)衡量性能。

<div  align="center">
	<img src="../assets/l7-lb.webp" width = "600"  align=center />
	<p>图4-4 L7负载均衡</p>
</div>

如图 4-4 所示，为一个 L7 HTTP/2 负载均衡器。这种情况下，客户端与 LB 只建立一个 HTTP /2 TCP 连接。LB 接下来和两个后端建立连接。当客户端向 LB 发送两个 HTTP/2 流（streams ）时，stream 1 会被发送到后端 1，而 stream 2 会被发送到后端 2。因此，即使不同客户 端的请求数量差异巨大，这些请求也可以被高效地、平衡地分发到后端。L7 负载均衡具备检测应用层流量的能力，这就是 L7LB 对现代协议如此重要的原因。

## 4.1.4  是否还需要 L4 负载均衡

我们前面解释了 L7 负载均衡器对现代协议的重要性，那么是否意味着 L4LB 已经没有用了？肯定不！虽然在 service-to-service 通信中 L7 负载均衡最终会完全取代 L4 负载均衡，但 L4 负载均衡在边缘仍然是非常有用的，因为几乎所有的现代大型分布式架构都是在公网流量入口使用 L4/L7 两级负载均衡架构。在边缘 L7 负载均衡器之前部署 L4 负载均衡器的原因：

- L7LB 承担的更多工作是复杂的分析、变换、以及应用流量路由，他们处理原始流量的能 力（按每秒处理的包数和字节数衡量）比经过优化的 L4 负载均衡器要差。这使得 L4LB 更适合处理特定类型的攻击，例如 SYN 泛洪、通用包（generic packet）泛洪攻击等
- L7LB 部署的更多更频繁，bug 也比 L4LB 多。在 L7 之前加一层 L4LB，可以在调整 L7 部署的时候，对其做健康检查和流量排除（drain），这比（单纯使用）现代 L4LB 要简单的多，后者通常使用 BGP 和 ECMP（后面会介绍）。
- 最后，因为 L7 功能更复杂， 它们的 bug 也会比 L4 多，在前面有一层 L4LB 能及时将有问题的 L7LB 拉出。
