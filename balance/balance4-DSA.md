# DSA

<div  align="center">
	<img src="../assets/balancer4-dsr.svg" width = "550"  align=center />
	<p>图4-2 DSA 模式负载均衡</p>
</div>


与 NAT 不同，负载均衡器通常使用 GRE[^1]（Generic Routing Encapsulatio，通用路由封装）将 IP 包封装发送到后端。后端收到后进行解封装后可以拿到原始的 IP 包，里面有客户端的 IP 和 port 信息，因此后端可以直接将应答包发给客户端而不需要再经过 L4LB。只有请求经过负载均衡器，而服务的响应无需从负载均衡器原路返回的工作模式中，整个请求、转发、响应的链路形成一个“三角关系”，所以这种模式也被形象的称为“三角传输模式”（Direct Server Return，DSR），也称为“单臂模式”（Single Legged Model）或者 LVS 中的 DR 模式（Direct Routing，直接路由）。

设计 DSR 的主要原因是：在一些场景中，响应的流量要远远大于请求的流量（例如典型的 HTTP request/response 模式）。假设请求占 10% 的流量，响应占 90%，使用 DSR 技术，只需 1/10 的带宽就可以满足系统需求，这种类型的优化可以极大地节省成本，还提高了负载均衡器的可靠性（流量越低肯定越好）。

不过虽然 DSR 模式效率很高，但它在网络侧受到的约束也很大。DSR 模式改写目标 MAC 地址的工作方式决定了它于真实服务器的通信必须是二层可达的，通俗的说，使用 DSR 模式 L4LB 和 真实服务器必须位于同一个子网内，无法跨 VLAN。

所以，优势（效率高）和劣势（不能跨子网）共同决定了 DSR 模式最适合作为数据中心的第一层均衡设备，用来连接其他的下级负载均衡器。

[^1]: GRE 就是先将原始 IP 包封装在 GRE 内部，接着再次将 GRE 包封装到新 IP 包中，然后加入链路层帧头，最后发出去。GRE、VxLAN、IPSec 都可认为是一种 VPN 技术。