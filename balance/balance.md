# 4.1 负载均衡概述

广义的负载均衡包括操作系统使用负载均衡来跨物理处理器调度任务、容器编排器使用负载均衡来跨集群调度任务、网络负载中跨可用后端调度网络任务等等。本章我们讨论的内容主要为网络负载均衡。

无论何种形式的负载均衡，所共性的职责本质都为“选择谁来处理用户请求”和“将用户请求转发过去”，如图 4-2 所示的负载均衡高层架构图，若干客户端正在访问若干后端服务，中间的负载均衡器完成以下功能：

- 服务发现：系统中哪些后端可用、它们的地址是什么（负载均衡器如何能够联系上它们）。
- 健康检查：哪些后端是健康的，可以正常接收请求。
- 负载均衡：用哪种算法来均衡请求至健康的后端。

<div  align="center">
	<img src="../assets/blancer.webp" width = "600"  align=center />
	<p>图4-2 负载均衡架构</p>
</div>


在分布式系统中正确地使用负载均衡可以带来这些好处：

- 命名抽象化：客户端无需知道每个后端（服务发现），只要能找到负载均衡器就行了，名称解析委托给负载均衡器。
- 容错：通过健康检查和各种算法，负载均衡器可以有效地绕开不良或超载的后端。
- 开销和性能优势：分布式系统的网络很少是同构的，系统很可能跨多个网络 zone 和 region。负载均衡可以最大限度地将请求流量保持在 zone 内部，即提高性能（更低的延迟）又降低整体系统成本（减少跨 zone 带宽）。

业内讨论网络负载均衡器的时候，负载均衡器（load balancer）和代理（proxy） 两个术语经常无差别混用，本文也将沿用这种惯例，认为二者整体上对等，但严格地讲，并非所有代理都是负载均衡器，但绝大多数代理都有负载均衡功能。

现在，当讨论网络类型的负载均衡的时，所有解决方案通常分为两类：四层负载均衡和七层负载均衡。这两者分别对应 OSI 模型的 4 层和 7 层。

我们先来看一看四层负载均衡。



## 4.1.4 负载均衡的特性

本节将简要总结负载均衡器提供的高层特性。但并不是所有负载均衡器都提供这里的所有特性。

### 1. 服务发现

服务发现是负载均衡器判断它有哪些可用后端的过程。用到的方式差异很大，这里给出几个例子：

- 静态配置文件
- DNS
- Zookeeper, Etcd, Consul 等待
- Envoy 的通用数据平面 API

### 2. 健康检查

健康检查是负载均衡器判断它的后端是否可以接收请求的过程。大致分为两类：

- 主动：LB 定时向后端发送 ping 消息（例如，向 /healthcheck 发送 HTTP 请求）， 以此测量后端健康状态
- 被动：LB 从数据流中检测健康状态。例如，L4LB 可能会认为如果一个后端有三次连接错误， 它就是不健康的；L7LB 可能会认为如果后端有 503 错误码就是不健康的

### 3. 负载均衡

LB 必须保证负载是均衡的。给定一组健康的后端，如何选择哪个后端来处理一个连接或一 个请求呢？负载均衡算法是一个相对活跃的研究领域，从简单的随机选择、Round Robin， 到更复杂的考虑各种延迟和后端负载状态的算法。

### 4. 黏性会话

对于一些特定应用，保证属于同一 session 的请求落到同一后端非常重要。这可能需要考 虑缓存、结构复杂的临时状态等问题。session 的定义也并不相同，可能会包括 HTTP cookies、客户端连接特性（properties），或者其他一些属性。

### 5. 可观测性

网络在本质上是不可靠的，LB 通常需要导出统计、跟踪和日志信息，以帮助运维判断出了什么问题并修复它。负载均衡器输出的可观测性数据差异很大。高级的负载均衡器提供丰富的输出，包括数值统计、分布 式跟踪以及自定义日志。需要指出的是，丰富的可观测数据并不是没有代价的，负载均衡器需要做一些额外的工作才能产生这些数据。但是，这些数据带来的收益要远远大于为产生它们而增加的那点性能损失。 

### 6. 安全和 DoS 防御

尤其在边缘部署拓扑情况下，负载均衡器通常需要实现很多安全特性，包括限速、鉴权和 DoS 防御（例如，给 IP 地址打标签及分配标识符、tarpitting 等等）
