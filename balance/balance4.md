# 4.3 四层负载均衡概论


<div  align="center">
	<img src="../assets/balancer4.svg" width = "600"  align=center />
	<p>图4-3 TCP L4负载均衡</p>
</div>

如图 4-3 所示，为一个传统的四层 TCP 负载均衡器。这种情况下，客户端建立一个 TCP 连接到 LB。LB 终止这个连接（例如 ，立即应答 SYN 包），选择一个后端，然后建立一个新的 TCP 连接到后端（例如，发送一 个新的 SYN 包）。典型情况下，L4LB 只工作在 L4 TCP/UDP connection/session 中。因此，LB 双向来回转发字节，保证属于同一 session 的字节永远落到同一后端。L4LB 不感知其转发字节所属应用的任何细节，所以 L4 应用范围很广。

四层负载均衡的的特点也是其缺点，设想如下特殊场景：

1. 两个 gRPC/HTTP2 客户端们通过 L4LB 建立连接到后端。
2. L4LB 为每个进来（从客户端）的连接建立一个出去的（到后端）的连接，因此有两个进来的连接和两个出去的连接。
3. 客户端 A 的连接每分钟发送 1 个请求，而客户端 B 的连接每秒发送 50 个请求。

以上场景中，由于 L4 同一个 session 的字节永远落到同一后端，选中的处理客户端 A 请求的后端比选中的处理客户端 B 请求的后端，负载要相差很多倍，这就与负载均衡的目的背道而驰。

由于性能考虑（创建 TCP 连接的开销非常大，尤其连接使用 TLS 加密的时候），所有现代协议都在演进以支持 multiplexing（多路复用） 和 kept-alive（连接保活），因此 L4LB 的阻抗不匹配问题随时间越来越彰显。
