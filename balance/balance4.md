# 4.3 四层负载均衡概论

现在所说的“四层负载均衡”其实是多种均衡器工作模式的统称，“四层”的意思是这些工作的模式共同特点是维持同一个 TCP 连接，而不是说它只工作在 OSI 模型的四层。事实上，这些模式主要工作在第二层（数据链路层，改写 MAC 地址）和第三层（网络层，改写 IP 地址），而第四层（传输层，改写 UDP、TCP 等协议的内容端口号）单纯只处理数据，做 NAT 之类的功能，所以无法做到负载均衡的转发。

因为 OSI 模型的下三层是媒体层(Media Layer)，上四层是主机层（Host Layer），既然流量已经到了目标主机了，也谈不上什么流量转发，最多只能做代理，但出于习惯，现在所有的资料都把它们称为四层负载均衡，笔者也继续沿用这种惯例，不论是 IP 层处理还是链路层处理，统称四层负载均衡。

四层负载均衡最典型的软件实现是 LVS（Linux Virtual Server，Linux 虚拟服务器），但笔者并不过多介绍 LVS 的相关特点和如何使用，而是结合 TCP flow 处理的角度去解释 LVS 中 DR、NAT、Tunnel 工作模式是如何工作的。

如图 4-3 所示，一个传统的四层 TCP 负载均衡器，客户端建立一个 TCP 连接到 L4LB，L4LB 终止这个连接（例如立即应答 SYN 包），选择一个后端，然后建立一个新的 TCP 连接到后端（例如发送一个新的 SYN 包）。

<div  align="center">
	<img src="../assets/balancer4.svg" width = "500"  align=center />
	<p>图4-3 TCP L4负载均衡</p>
</div>

典型情况下，L4LB 只工作在传输层 TCP/UDP connection/session 中，因此，L4LB 双向来回转发字节，保证属于同一 session 的字节永远落到同一后端。由于 L4LB 不感知其转发字节所属应用的任何细节，所以 L4LB 应用范围很广。

四层负载均衡的的特点也是其缺点，设想如下特殊场景：

1. 两个 gRPC/HTTP2 客户端们通过 L4LB 建立连接到后端。
2. L4LB 为每个进来（从客户端）的连接建立一个出去的（到后端）的连接，因此有两个进来的连接和两个出去的连接。
3. 客户端 A 的连接每分钟发送 1 个请求，而客户端 B 的连接每秒发送 50 个请求。

以上场景中，由于 L4LB 同一个 session 的字节永远落到同一后端，选中的处理客户端 A 请求的后端比选中的处理客户端 B 请求的后端，负载要相差很多倍，这就与负载均衡的目的背道而驰。

由于性能考虑（创建 TCP 连接的开销非常大，尤其连接使用 TLS 加密的时候），以及所有现代协议都在演进以支持 multiplexing（多路复用） 和 kept-alive（连接保活），因此 L4LB 的阻抗不匹配问题随时间越来越彰显。

LVS 版本有 3 种工作模式，DR、NAT、Tunnel，下面笔者根据 TCP flow 的处理讲讲这几种四层负载均衡的工作模式。