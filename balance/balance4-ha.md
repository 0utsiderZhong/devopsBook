# 4.3.2 四层负载均衡高可用设计

到目前为止，我们讨论的都是单个四层负载均衡器的设计以及工作模式，假如这个负载均衡器在生产环境中宕机了呢？事实上，四层负载均衡器大都作为大型分布式系统的唯一对外入口，如果四层负载均衡器是单节点部署，一旦宕机，对于整个系统而言绝对是毁灭级别的故障。

为了避免单个负载均衡器挂掉导致应用不可用，负载均衡器通常都是以高可用对（主备）方式部署，如图所示，这种高可用典型的设置包括，一对主备边缘路由器提供若干 VIP（virtual IP，虚拟 IP），并通过 BGP 协议通告 VIP，主边缘路由器的 BGP 权重比备边缘路由器的高，在正常情况下处理所有流量；类似地，主四层负载均衡器向边缘路由器宣告它的权重比备用四层负载均衡器大，因此正常情况下它处理所有流量；主备四层负载均衡器之间交叉连接， 共享所有的连接跟踪状态。因此，假如主挂了，备可以马上接管所有活动连接

<div  align="center">
	<img src="../assets/balancer-ha.svg" width = "600"  align=center />
	<p>图4-4 负载均衡主备设计</p>
</div>


我们可以看到以上的设计如何避免 HA pair 的不足：

- 边缘路由器和负载均衡器实例可以按需添加。每一层都用到了 ECMP，当新实例加入的时候，ECMP 能最大程度地减少受影响的 flow 数量
- 在预留足够的突发量（burst margin）和容错的前提下，系统的资源利用率想达到多高就可以到多高


所有现代 L4 负载均衡系统都在朝着这种设计（或其变种）演进。其中最有名的两个分别是来自 Google 的 Maglev 和来自 Amazon 的 Network Load Balancer 。