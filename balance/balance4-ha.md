# 四层负载均衡高可用方案

到目前为止，我们讨论的都是单个四层负载均衡，但假如这个负载均衡挂了呢？如果一个 LB 实例挂了，那所有经过这个 LB 的连接都会受到影响。事实上，一般 L4LB 都作为分布式系统的唯一入口，一旦 L4LB 宕机，绝对是灾难性的故障。

为了避免单个负载均衡器挂掉导致应用不可用，负载均衡器通常都是以高可用对（high availability pair）方式部署，如图所示，典型的 HA 负载均衡器设置包括：

- 一对 HA 边缘路由器提供若干 VIP（virtual IP，虚拟 IP），并通过 BGP 协议通告 VIP，主边缘路由器（primary）的 BGP 权重比备边缘路由器（backup）的高，在正常情况下处理所有流量。
- 类似地，primary L4LB 向边缘路由器宣告它的权重比 backup LB 大，因此正常情况下它处理所有流量。
- primary LB 交叉连接（cross-connected）到 backup LB， 共享所有的连接跟踪状态。因此，假如 primary LB 挂了，backup LB 可以马上接管所有活动连接
- 两个边缘路由器和两个负载均衡器都是交叉连接的。这意味着，如果一个边缘路由器或一 个负载均衡器挂了，或者由于某种原因之前声明的 BGP 权重收回了（withdraw），backup 马上可以接受所有流量。