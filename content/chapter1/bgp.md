# 网络互联：BGP协议与AS自治系统

中小型局域网几百台、几千台可以用RIP、OSPF等路由协议组网，但互联网上亿台主机如何解决互联问题呢？

解决方式就是整个互联网按组织边界、管理边界等划分为多个自治系统（Autonomous System ，AS），每个自治系统由一组运行相同的路由协议、路由选择算法的路由器组成，由于AS的规模较小，路由算法不会产生性能问题。


<div  align="center">
	<img src="../assets/chapter1/bgp.png" width = "300"  align=center />
</div>

上面的解释涉及了IP网络中数据包传递的两个重要的概念：`AS`、`BGP`。


## 什么是AS

更具体地说，自治系统（AS）是具有统一路由策略的巨型网络或网络群组。连接到 Internet 的每台计算机或设备都连接到一个 AS。

一个运营商或者IDC机房想要进入互联网，需要在CNNIC或APNIC申请IP地址段和AS号，然后通过EGP协议将此段IP地址广播到到其他网络运营商参与互联。

大多数 AS 会连接到其他几个 AS。如果一个 AS 仅连接到另一个 AS 并共享相同的路由策略，则可以将其视为第一个 AS 的子网。每个 AS 都控制一组特定的 IP 地址。


一个上海的数据包发送到美国，靠的是BGP协议，根据可达性和路由信息，权衡最新的网络状况，从而找到这两个点之间的最佳路径。

如下图展示了一个简化版的 BGP。在此版本中，互联网上有 6 个自治系统。


<div  align="center">
	<img src="../assets/bgp-router.png" width = "500"  align=center />
</div>


如果 AS1 需要向 AS3 路由一个数据包，它有两种不同的选择：`AS2 → AS3`或`AS6 → AS5 → AS4 → AS3`。**但遗憾的是现实中的真实情况：路由往往不是最短路径选择，而是费用最便宜选择。**

## 什么是 BGP

BGP 是在 AS 之间路由数据包的边界网关协议。AS 通过 BGP 通知其到其他 AS 和路由器的路由策略。

BGP 路由器从世界各地的 AS 中获取所有这些信息，并将其放入AS 内的路由表，以确定从 AS 到 AS 的最快路径。当数据包到达时，BGP 路由器会参考其路由表来确定数据包接下来应转到哪个 AS。

全世界有许多 AS，BGP 路由器不断更新其路由表。网络脱机时，新网络联机时，AS 扩展或收缩其 IP 地址空间，所有这些信息都必须通过 BGP 通知，以便 BGP 路由器可以调整其路由表。


### BGP工作原理

BGP基于（Path Vector Protocol）路径矢量来实现，每个BGP服务的实体叫做BGP Router，而与BGP Router连接的对端叫BGP Peer。

BGP Router在收到了Peer传来的路由信息，会存储在自己的数据库。BGP Router会根据自己本地策略结合路由信息中内容判断处理，如果路由信息符合本地策略，BGP Router会修改自己的主路由表。

本地策略会有很多，如果BGP Router收到两条路由信息，目的网络一样，但是路径不一样， 如：

1. 一个是AS1->AS3->AS5
2. 一个是AS1->AS5

如果没有其他的特殊策略 BGP Router 会选用AS1->AS5这条路由信息。由此 BGP 可以实现复杂的控制，以及更有保障性的网络。


BGP 是唯一使用 TCP 作为传输层的路由协议，基于 TCP 连接可靠性和互联网大量的路由信息（TCP连接的窗口是65K字节，也就是说TCP连接允许在没有确认包的情况下，连续发送65K的数据） BGP 非常适合于大规模网络环境。

BGP可以在网络中扩容到几百台路由器的规模，如果再使用 BGP Route Reflection, 更能扩容到数万台，在大规模的组网中，通常都利用BGP提高路由规则可扩展性。比如云原生中的 Calico 用的也是 BGP。


## BGP 的应用

###  BGP机房

一个机房拥有了AS号，意味着拥有了与网络运营商同等级别的网络调度能力，建立的对等数越多，网络的互联性就越好。运维常说的 BGP九线、BGP六线机房，就是机房申请了AS号，拥有独立的IP段，并使用了BGP协议和其他众多ISP运营商做了对等互联。


BGP机房除了更好的连通性外，还有`冗余备份`、`路由环路消除`特点。在使用多线、或者单线机房时候，我们常常会申请多个VIP（Virtual IP），当时某个线路出现问题时，再手动从DNS中摘除，相当麻烦。

而使用BGP机房，只要一个VIP（Virtual IP），当某个运营商至机房连通出现问题，其用户自动切换至其他线路。

机房或者ISP的AS号 可以用过 mtr 等路由工具获取，获取AS号之后可以在网络中心获取该AS的一些基本信息，如建立的对等网络、所含CIDR、物理位置信息等等。。

如爱奇艺网络的AS为AS133865，通过该网址获取AS信息 [https://bgpview.io/asn/133865](https://bgpview.io/asn/133865)


