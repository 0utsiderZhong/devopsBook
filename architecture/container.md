# 1.6.1 容器技术

聊云原生避不开容器技术，聊容器技术避不开云原生，容器技术和云原生就是一堆双螺旋体，容器技术崔生了云原生思潮，云原生技术推动了容器技术的发展。

在介绍容器技术之前，我们先聊聊这些虚拟化技术的本源是什么。

在我看来，本源是摩尔定律的发展让资源过剩无法充分利用。受摩尔定律影响，摩尔定律主张处理器的性能每18个月翻一番，这就意味着我们拥有的计算资源会以惊人的速度递增。然而，许多应用并无法充分利用这些资源，特别是在每个应用对资源的需求都在变化的情况下。

虚拟化技术的产生，正是为了解决这个问题。通过虚拟化技术，一台物理服务器可以被分割成多个虚拟服务器，独立的资源分配让虚拟服务器可以更加高效并且灵活的利用硬件资源。


## 1.容器技术初现

在OS虚拟化这条技术路线上，最大的技术贡献来源于Google。

2006年，Google推出Process Containers，用来对一组进程进行限制、记账、隔离资源（CPU、内存、磁盘 I/O、网络等），Process Container 在 2006 年正式推出后，第二年就进入了 Linux 内核主干，并正式更名为 Cgroups，标志着 Linux 阵营中“容器”的概念开始被重新审视和实现。

2008 年 Linux Kernel 2.6.24 内核在刚刚开始提供 cgroups 的同一时间，立刻将 Cgroups 的资源管理能力和 Linux Namespace（命名空间）的视图隔离能力组合在一起，形成了完整的容器技术LXC（Linux Container），这就是如今被广泛应用的容器技术的实现基础。

至2013年阶段，Linux 虚拟化技术已经基本上成型，通过cgroups、Namespace及安全防护机制已经大体上解决了容器核心技术之一的运行环境隔离技术。

虽然容器运行环境隔离技术已经基本就位，但我们仍需等待另外一项关键技术才能迎来容器技术的爆发繁荣。

## 2.Docker的出现

2013年之前，云计算行业一直在为云原生的正确打开姿势而操心。

PaaS看起来是个有前途的方向，2008年Google推出GAE；2011年Pivotal发布Cloud Foundry。这些早期的PaaS平台进行了非常有益的探索，推动了云计算生态的健康发展，但是这些早期探索技术并没有形成大的行业趋势，而是局限在一些的特定的领域。

直到Docker开源，大家才如梦方醒，原来不是方向不对，而是应用分发和交付的手段不行。

Docker真正核心的创新是容器镜像（docker image），一种新型的应用打包、分发和运行机制。容器镜像将应用运行环境，包括代码、依赖库、工具、资源文件和元信息等，打包成一种操作系统发行版无关的不可变更软件包。

- 容器镜像打包了整个容器运行依赖的环境，以避免依赖运行容器的服务器的操作系统，从而实现“build once，run anywhere”。
- 容器镜像一但构建完成，就变成read only，成为不可变基础设施的一份子。
- 操作系统发行版无关，核心解决的是容器进程对操作系统包含的库、工具、配置的依赖，但是容器镜像无法解决容器进程对内核特性的特殊依赖。


Docker的宣传口号是“Build，Ship and Run Any App，Anywhere”。我们已经理解了docker通过container image解决“Run Anywhere”的机制，那么“Run Any App”是如何实现的呢？其实也是依赖container image，用户可以打包任何容器进程所依赖的环境，而不用改造应用来适配PaaS定义的运行环境。真是“Run Any App”一举打破了PaaS行业面临的困境，创造出了无限的可能性，大力推动了云原生的发展。


<div  align="center">
	<img src="../assets/docker.png" width = "500"  align=center />
	<p>图 Docker的愿景：Build, Ship, and Run Any App, Anywhere</p>
</div>

至此，容器技术体系已经解决了最核心的两个问题：如何发布软件和如何运行软件。至此，云计算进入容器阶段。

Docker 作为一个单机软件打包、发布、运行系统，其价值是非常巨大的。但仅仅将docker技术局限在单机范围内不能发挥这个创新技术的最大价值。

## 3.OCI时代

## 4.容器编排时代

## 2.容器编排

聊到容器编排系统，我们需要从Google聊起。2008年，Google基于LXC推出了应用托管平台服务GAE（Google App Engine）。GAE 是一种分布式平台服务，Google 通过虚拟化技术为用户提供开发环境、服务器平台、硬件资源等服务，用户可以在平台基础上定制开发自己的应用程序并通过 Google 的服务器和互联网资源进行分发。

Google在GAE中使用了一个能够对LXC进行编排和调度的工具 --- Borg（也就是Kubernetes的前身）。Borg 是 Google 内部使用的大规模集群管理系统，可以承载十万级的任务、数千个不同的应用、同时管理数万台机器。Borg 通过权限管理、资源共享、性能隔离等来达到高资源利用率。它能够支持高可用应用，并通过调度策略减少出现故障的概率，提供了任务描述语言、实时任务监控、分析工具等。如果说一个个隔离的容器是集装箱，那么 Borg 可以说是最早的港口系统，而 LXC + Borg 就是最早的容器编排框架。

2013年docker推出之后迅速席卷全球，2014年Google基于内部使用的Borg系统创建了开源项目Kubernetes（简称K8S），用于解决大规模集群的容器部署、运行、管理等问题。Kubernetes在容器的基础上增加了一层的新的管理抽象Pod，以便更好地利用容器进行应用的功能模块切分。得益于 Google 在大规模集群基础设施建设的强大积累，脱胎于 Borg 的 Kubernetes 很快成为了行业的标准应用。


## 3.容器标准规范

容器引擎(docker vs rocket)、容器编排（docker swarm、Kubernetes、Apache Mesos）的相互竞争结果就是大家坐下来谈接口标准。

2015年6月，Docker带头成立OCI，OCI组织着力解决的是容器的构建、分发和运行问题。

:::tip OCI宗旨
制定并维护容器镜像格式和容器运行时的正式规范（OCI Specifications）”，：
:::

其核心产出是：

1. OCI Runtime Spec（容器运行时规范）
2. OCI Image Spec（镜像格式规范）
3. OCI Distribution Spec（镜像分发规范）。


一个月之后，Google带头成立了Cloud Native Computing Foundation（CNCF），CNCF组织解决的是应用管理及容器编排问题。

:::tip CNCF宗旨
构建云原生计算 —— 一种围绕着微服务、容器和应用动态调度的、以基础设施为中心的架构，并促进其广泛使用
:::

这两个围绕容器的基金会对云原生生态的发展发挥了非常重要的作用，二者不是竞争而是相辅相成（竞争的都已经淹没在历史的长河中），共同制定了一系列行业事实标准。这些行业事实标准的确立，各行业注入了无限活力，基于接口的标准的具体实现不断涌现，呈现出一片百花齐放的景象。


<div  align="center">
	<img src="../assets/container-2.jpeg" width = "650"  align=center />
	<p>图 容器编排生态</p>
</div>

其中，与容器相关的最为重要的几个规范包括：CRI、CNI、CSI、OCI Distribution Spec、OCI Image Spec、OCI Runtime Spec和Shimv2。这些标准规范我们也将在本书后续篇节进行深入介绍和实践。