# 负载均衡与网关的实践

负载均衡SLB（Server Load Balancer）是一种对流量进行按需分发的服务，通过将流量分发到不同的后端服务器来扩展应用系统的吞吐能力，并且可以消除系统中的单点故障，提升应用系统的可用性。

在互联网业务中SLB通常作为所有流量的入口，与弹性伸缩服务协同工作，形成一个完整的自动化扩容和缩容的解决方案，帮助应用系统实现高可用、高性能、高并发的目标。

在网络负载均衡类型中，按层分可以分为两种：

- 基于TCP/IP四层流量负载均衡
- 基于应用层协议的七层负载均衡

## 四层负载均衡

四层负载均衡是基于Linux内核对IP数据包路由分发。

经典的LVS就是在Linux内核中利用netfilter对IP包就行修改转发，以实现流量分发的负载均衡目标。

在高可用性的架构中，可以通过等价路由或者冗余路由协议，虚拟出一个VIP，内部实现多台双活或主备的方式，四层的方案仅作为流量入口处理IP数据包转发，无法识别上层协议，灵活性很差，但性能指标较好，一般用pps(包转发/秒)衡量性能。

在企业应用中，通常是用LVS配合OSPF实现多活入口，再配合后端7层的应用协议处理网关。

## 七层负载均衡

七层负载均衡的技术有点是可以识别应用层协议（缺点是流量必须要全部经过该节点，是一种代理方式）。

七层负载均衡的方案可以通过对HTTP头、数据类型、请求类型做做复杂的逻辑处理，实现更灵活的控制，比如检查流经的HTTP报文头，根据报头内的URL、Cookie等等来实现请求的均衡。

在此类方案的应用上通常处理核心是Nginx。配合Lua，如 OpenResty，再实现功能丰富且性能较高的网关方案。

这类技术的底层使用 epoll以及LuaJIT相关的技术实现高并发的支撑，可以实现C10k的并发处理。一般用qps(请求/秒)衡量性能。



