# Kubernetes的概念以及组件介绍

笔者在本章开篇阐述了我个人对云原生的一些理解, 一句话来解释：云原生实际上是一种对应用支持的现代开发理论，实现诸如：容器化、持续交付、DevOps、微服务..

要对业务实现诸上特性，需要一套完全新的、颠覆性的开发理论，得有一个”操作系统“来支持这些业务的云上特征， 而 Kubernetes 就是这样一套”云上操作系统“。

CNCF有个云原生全景图:

<div  align="center">
	<img src="/assets/chapter4/cncf.jpeg" width = "750"  align=center />
</div>

该图中包括云原生的各种层次的插件和应用，通过该图可以组合出一些列的云原生平台。

- IaaS云提供商（公有云、私有云）
- 配置管理，提供最基础的集群配置
- 运行时，包括存储和容器运行时、网络等
- 调度和管理层，协同和服务发现、服务管理
- 应用层

除此 您更可基于 Kubernetes 进行 可观测性、分析和扩展应用。通过这个全景图，能理解到 Kubernetes 实际上制定了一个标准， 就像一个 Linux系统，Kubernetes 通过组合各类 标准化的扩展和插件来构建丰富、成熟的云上应用。

## Kubernetes 是什么

容器的出现，让应用的管理和部署产生了一种全新的方式，虽然容器化部署可以带来很多便利，但是也会出现一些问题：比如一个容器宕机了，怎么让另外一台容器快速替补。
当系统负载过高的时候，如何实现快速的横向扩容，当负载较小时，如何能进行缩容，实现成本上的较低。

上面的这些问题统称为容器编排问题。为了解决这些问题，也出现了 诸如 Swarm（Docker自己的容器编排）、Mesos （Apache下的编排工具）

而Kubernetes就是其中最流行的容器编排应用

事实上只要是能容器化的应用，都可以在 Kubernetes 上部署，Kubernetes 最擅长的事情 故障转移和 高可用， Kubernetes 提供了一个弹性的分布式系统框架，照顾到了这些应用编排、服务治理等等多个方面

另外我们基于 Kubernetes、Node、容器管理的方式，可以实现私有云和公有云融合的混合云架构，轻松实现机房多活的架构方案，以及 整体业务 迅速在云之间转移的能力。


## Kubernetes 不是什么

因为操作在容器级别层面而不是硬件层面，使得 Kubernetes 提供了一些如部署、扩容、负载均衡等和PaaS平台类似的特性，但这里要强调 Kubernetes 并不是一个传统的包罗万象的PaaS平台，它的思想是提供最核心的基础框架和必要的核心功能，而在其他的选择 如 日志、监控、报警、CI/CD等 上尽可能保证多样的兼容性和灵活性，这也是 Kubernetes 能构建丰富的生态中重要原因

- Kubernetes 不限制支持的应用类型： 包括无状态（Nginx）、有状态（数据库）、数据处理(AI、大数据、深度学习)，应用只要能实现容器化，统统可以使用 Kubernetes 管理。

- Kubernetes 没有 CI/CD：但您可以使用 Jenkens、Tekton 打造 Kubernetes devops平台
- Kubernetes 不提供日志、监控和报警等解决方案
- Kubernetes 不提供也不采用任何全面的机器配置、维护、管理或自我修复系统
- Kubernetes 也不提供中间件、数据库、数据存储集群等作为内置的应用层服务

总应用的类型看：

在有状态服务的支持上，现在Kubernetes提供了 Stateful Set、Local Persist Volume，Operator 等一系列，使得数据库也能很好的运行在 Kubernetes 之上。


Kubernetes 不仅仅是一个编排系统，实际上它消除了编排的需要，K8s通过声明式的 API 和一系列独立、可组合的控制器保证了应用总是在期望的状态，用户并不需要关心中间状态是如何转换的，也不需要集中控制，这使得系统更易于使用 且功能更强大、系统更健壮、更为弹性和可扩展。


## Kubernetes的复杂性问题

Kubernetes 推出的宗旨是要解决 类似 Google 这种庞大规模计算资源管理的问题， 由此 Kubernetes 也相应的引入了更多的复杂性。

Kubernetes的复杂性首先在于架构，本质上 Kubernetes 是用来管理分布式系统的平台，分布式本身就是技术界的难题，管理分布式系统的平台自然也不例外。其次 在于容器的网络，前面也介绍过 wxlan、虚拟设备等等技术，这导致在这之上的云业务出现问题排查有很大的困难。 最后还有格式样的组件，如 calico、Cilium 内部的流程更是如天书一般。


## 什么情况下用 Kubernetes 

我跟一些同行交流，多数的情况下谈话中都会产生一个疑惑：Kubernetes 那么美好，能故障漂移、能弹性缩容、等等，那我们的服务要不要上 Kubernetes? 包括我在所在部门内部也跟同事们交流这个话题。

从笔者的角度来看有两个条件要确立：资源规模是否足够大、技术的财务成本是否过高

很多情况下公司使用 Kubernetes 极容易陷入一个美好的技术陷阱：即在一个固定资源池的场景下（比如一定不变数量级的公有云ECS）为使用 Kubernetes 而使用 Kubernetes！！服务的故障自愈、资源编排治理有非常多的方式，Keepalived、OpenResty、Consul 这几个技术就可以实现了啊，为何用 Kubernetes 呢？ 而且 Kubernetes 的技术成本也非常高。

在固定资源池内搞动态缩容，这种情况下就算缩容出了 Node，也没有省下钱来！！

特别像我所工作的产品，是个典型的内容流量型服务，存在晚高峰、节假日高峰流量差异特别大的情况。一定不能基于固定资源搞动态伸缩。

### 基于降本的角度 理解 Kubernetes 的应用

我以我所在部门服务的为案例，讲解笔者个人对 Kubernetes对降本的意义

- DevOps体系一定要打通私有云和公有云的接口，内部要实现 DevOps 平台管理 Kubernetes集群所有的节点 （ECS、裸金属），有效纳管公有云平台。
- 做全局资源的监控，而不是局限于 Kubernetes 的监控，规划资源阈值的风险
- 做好 Kubernetes 集群的管理和控制，弹性伸缩 Node

做好以上的规划后，一旦全局资源预警，DevOps平台立刻调用公有云平台的接口，创建出所需的 ECS，并加入到 Kubernetes 集群。这样在流量高峰阶段，资源随时扩容，不会给线上业务造成宕机或者大范围卡顿现象。

后面在流量低谷阶段，调用 DevOps 服务的API 删除新增进来的Node节点，在DevOps平台调用公有云释放新增的 ECS。

另外如果是同城双机房的架构，还可以调整双机房资源50% 50%的双活模式，极大地降低成本。

阿里云香港机房在2022年12月发生了一次区域性的机房宕机，此刻您的DevOps体系如果实现了多公有云平台的管理，在这种情况下迅速调用香港其他云服务商扩容资源， 就可以保证在分钟级内实现云级别的故障平滑迁移。 


所以说驱使我们导向 Kubernetes 核心原因就是：成本。 