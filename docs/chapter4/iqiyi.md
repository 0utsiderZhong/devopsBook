# 两地三中心的一个构思

2019年爱奇艺开始拓展海外用户，爱奇艺海外产品的形态和运营模式基本和国内一致，为了快速扩展市场，爱奇艺海外业务的基础架构基本完全复制了基线的方式。

这种方式，让海外业务快速建立了完整的技术服务体系，在这套体系的扩展下，也满足了市场运营的各类需求。但随着时间的推移，也开始逐渐出现人力、资源成本等各类问题，爱奇艺的国内服务架构是一个很庞大、复杂的体系，而海外还是一个刚处于初始阶段的业务，这就让海外的人均成本很高

其次基线的架构存在很多历史包袱，基础的虚拟服务有 虚拟机、Mesos、K8S... 这让内部的架构不统一很分散，这在基线没有问题，但在海外就有个“过度”设计，机器的空闲率太高。


还有一个问题，由于基线是异地多活，海外业务设计成了同城双活方式，基线的异地多活由于物理距离到底两个云之间延迟过高，完全双活没问题，但海外同城这种物理环境下，两个公有云的专线只要一跳就可以解决，延迟不会高于1ms

还有双活是个很复杂的体系，涉及的项目多了，一致性上很难协调。前几个月公有云挂了，海外的业务还是出现故障，双活不起作用。


## 改进的目标

分析以上的问题，首先列一个改进的目标，以及弄清楚为什么重构

笔者在 Kubernetes 内也讲述了技术升级的本质：是为了收益，降低人力、资源物力成本，而不是为了某个新奇的东西而搞技术升级。

第一个目标：成本。海外有xxx台服务器，综合这些服务器的利用率，数学加减法 削去 50%的资源，理论在业务支持上不会出现资源短缺的情况。

第二个是实现多云级别的高可用，公有云挂了，也有快速迁移的能力。参考 香港阿里云宕机了12小时。业务不可能等12个小时再恢复。


## 如何改进

对业务而言没有华为云、阿里云或者aws，只有奇艺新加坡混合云

基础架构的关键组件双活，有状态服务双活， 其他没有双活的概念



混合云devops平台实现 公有云对接，自动创建、销毁 ECS

流量高峰时，自动扩容 ECS， 流量低估 销毁 ECS



## 如何自动化升级操作

建立 k8s 融合集群

手动拉取 QAE内的项目，GITLAB的CI/CD权限， 尝试自动增加 service

service 对接 APISIX

APISIX内对 原项目进行分流测试

## 实践

模拟实践

