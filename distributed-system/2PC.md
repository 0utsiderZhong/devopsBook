# 2PC 分布式事务解决方案

在 CAP 定理的文章内，我们总结了三种系统架构：CA、CP、AP, 如果我们要设计一个强一致性的 CP架构系统，该如何实现呢？针对这一需求，逐渐诞生了二阶段提交以及三阶段提交协议。

## 二阶段提交协议

二阶段提交协议（Two-phase Commit Protocol，简称 2PC）是一个基于协调者的强一致性原子提交协议。 目前大部分关系数据库都是用二阶段提交来完成分布式事务。例如 Oracle、MySQL 所支持的 XA 协议也可归类于 两阶段提交协议，因此两阶段提交协议在分布式系统中被广泛应用于解决分布式事务相关问题。


## 二阶段协议概述

在分布式系统中，由于分支事务只能知道自己执行的结果，并不知道其他分支事务的执行情况，因此需要设计一个协调者的角色，各个分支事务向协调者上报执行状态，再由协调者根据各个分支事务的执行结果决定全局事务的提交或回滚。


二阶段提交的具体流程如下：

1. 应用程序向事务管理器提交请求，发起分布式事务；
2. 在第一阶段，事务管理器联络所有资源管理器，通知它们准备提交事务；
3. 各资源管理器返回完成准备（或准备失败）的消息给事务管理器（响应超时算作失败）；
4. 在第二阶段：
	- 如果所有资源管理器均完成准备（如图 1），则事务管理器会通知所有资源管理器执行事务提交；
	- 如果任一资源管理器准备失败（如图 2 中的资源管理器 B），则事务管理器会通知所有资源管理器进行事务回滚。