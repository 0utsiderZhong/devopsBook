# 共识问题

我们在设计一个数据服务时，为了满足整体系统的容错能力，通常需要多个节点同时提供服务，在执行写操作时，如何使每个成员数据保持一致，有下面两种方案：

1. 使用副本模式：副本模式约定特殊角色的成员如 Leader，让 Leader 执行写操作，然后将写请求再转发给副本成员 Slave。 但这种方式存在两个问题：
	- 数据延迟：Leader 写请求肯定再转发给 Slave，这存在一个中间状态。如果要获取最新的数据，只能将读写请求集中在 Leader 服务器，造成 Leader服务器压力过大。
	- 数据不一致：数据不一致的问题表现在 Leader 处理成功，但 Slave 因网络、自身问题处理失败，或者Leader发生故障， 导致 Leader 和 Slave 之间存在数据不一致的问题。

2. 所有的成员都执行写操作： 在所有的成员写操作执行成功之后，本次写操作才算执行成功。但这种方案无法保证所有的成员都能成功，当一个成员失败时，整个系统就判断写入失败，要执行回滚，而回滚又可能发生错误。


考虑到分布式环境下网络分区等问题无法消除，不再追求所有节点任何情况下一致性目标，改为采用 `多数派决策` 原则，一旦系统中过半数的节点中完成了状态的转换，就认为该操作在集群内已经到达共识。这种容忍少数节点不可用，并通过增加节点提升整体可用性的思想在分布式中 被称为 Quorum 机制。


## 共识

根据上面的讨论，我们需要设计出一种算法，能让分布式系统内部暂时存在不一致的状态，但要保证大多数节点的状态达成一致。同时，在外部看来，集群系统要始终保证整体一致性的状态。这个能让分布式集群即使是在部分节点故障、网络延时、网络分割的情况下，仍能最终表现出整体一致的过程，就被称为各个节点的协商共识（Consensus）。


实现共识的算法，就被称为共识算法，Paxos、ZAB、Raft 都属于共识算法，在分布式系统中，共识算法更多用于提高系统的容错性，比如分布式存储中的复制集（replication）模型。

但是，还是要注意，分布式事务 和 共识协议解决的是两类问题：

- 2PC 等协议解决的是分布式事务一致性，目标侧重于 ACID。
- Paxos/raft 解决的是副本间数据的一致性和高可用，存储的数据完全一致，目标侧重于集群系统容错能力。


