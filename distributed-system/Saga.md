# 补偿协议 Saga

Saga 是一种用于解决长事务的实现方案，是一种补偿协议。

该模式下，一个分布式事务内会有多个参与者，每个参与者都是一个带有补偿逻辑的服务，即该服务可以根据业务场景实现正向操作和逆向回滚操作

在 Saga 模式中，也存在一个事务管理器。在分布式事务的执行过程中，该事务管理器负责依次执行各个服务的正向操作。如果所有正向操作执行成功，那么整体分布式事务就可以提交并执行成功；如果任何一个服务的正向操作执行失败，那么事务管理器就会回退，执行前面各个服务的逆向回滚操作，让分布式事务回到初始状态，从而达到整体事务回滚的目的

Saga 模式非常适用于流程长且需要保证事务最终一致性的业务操作。在微服务中，一个业务请求需要跨越多个微服务应用的场景，就比较适合采用 Saga 模式。Saga 模式通常是基于事件驱动设计的，即每个服务都是异步执行的，不存在加锁、资源等待和阻塞的情况，所以性能非常高。在两阶段提交的方案中，XA 资源能够支持的通常是数据库事务；而在 Saga 模式中，服务可以以任何形式存在。如果是一个本身不支持回滚等事务操作的 NoSQL 资源，那么在补偿逻辑中，结合数据时间戳和资源提供的删除或更新接口也能保证数据回到全局事务之前的状态。比如只能单向操作的邮件系统，在分布式事务执行过程中，向客户发送了一封订单生成的通知邮件，则在回滚阶段可以再发送一封订单取消的通知邮件。总体来说，Saga 模式的正向逻辑和逆向补偿更为灵活，可以将更多的服务或资源加入分布式事务中

但 Saga 模式也存在问题，缺乏隔离性，当多个 Saga 事务同时操作一个订单时，缺乏隔离性会导致操作不是原子级的，会出现覆盖对方数据的问题。此问题的原因是多个事务并发操作统一资源，可以通过一些方式来解决覆盖对方数据的问题，比如应用层增加逻辑锁，或者通过顺序消息保证统一资源的串行化操作等