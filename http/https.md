# 2.6.1  理解HTTPS流程

HTTPS流程中涉及了证书、CA、TLS、对称/非对称加密等繁杂的环节。为了真正理解HTTPS完整的逻辑脉络，我们反行其道，从零开始设计一个“绝对”安全的信息传输机制，以理解为什么有这么多环节。

## 1.解决信息传递的安全性

首先，HTTPS 的本质是为了实现信息传递“绝对”的安全性。对于一个是 1 v 1的通信模型而言，想实现信息传递安全性，使用对称加密就可以。只要保证密钥的安全，不让第三者知道，安全的问题就能解决！

<div  align="center">
	<img src="../assets/https-1.png" width = "450"  align=center />
	<p>图：对称加密示例</p>
</div>

但对称加密方式在 HTTP 服务场景下就出现问题了。对称加密的核心是如何保证秘钥的安全性，而HTTP 通信模型是 1 v N，这种方式等同没有加密。 

<div  align="center">
	<img src="../assets/https-2.png" width = "400"  align=center />
	<p>图：对称加密 1vN 模式</p>
</div>

为了解决秘钥安全性问题，我们可以进行改进使每个客户端使用不同的算法，并在中间增加一个协商的过程，用于双方协商采用何种对称加密算法。

<div  align="center">
	<img src="../assets/https-3.png" width = "400"  align=center />
	<p>图：对称加密模式下密钥协商</p>

</div>

协商过程解决了对称加密算法或秘钥独立性问题，但协商过程依旧是明文的，密钥仍然存在被截获的可能性。为了解决这个问题，只能继续对协商过程的数据进行加密。对对称密钥进行加密必须换一种思路，如果仍然采用对称加密方式，就会产生无限套娃的情况。

这里引入非对称加密算法！

:::tip 非对称加密
非对称加密有两个密钥：公钥、私钥，私钥加密的密文只能公钥解，公钥加密的密文只能私钥解。
:::

同时，因为 HTTP 传输信息量一般较大，需要尽可能对内容提升加解密效率，所以在实现上，对通信内容进行对称加密，而这个对称加密的密钥则通过非对称加密得到。后续信息加密的流程就变成了在协商流程中，通过随机数确定一个加密算法，然后使用私钥加密算法、密文等，客户端再用公钥进行解密。

那么问题又来了，公钥如何传输给客户端呢？


## 2.证书认证机构

虽然服务端可以直接发送公钥证书至客户端，但无法避免中间被截获的问题。解决方案是采用可信任的第三方私钥将服务器公钥加密后传输给客户端，客户端再使用第三方公钥进行解密。

<div  align="center">
	<img src="../assets/https-4.png" width = "400"  align=center />
</div>

因此，最关键的是解决第三方公钥的问题。为了解决公钥安全传输给客户端，继续引入一个证书认证机构（CA，Certificate Authority ）。服务端向CA申请数字证书（数字证书通常包含公钥、持有者信息、证书认证机构（CA）的信息以及过期信息等），再发数据证书发给客户端。至于第三方 CA 公钥的问题，没有好的解决方案了，只能提前预装在系统内，也就是根证书。

至此，信息传递的安全性问题基本得到解决。

## 3.证书验证链

客户端下载证书之后，需要经过本地跟证书校验，此处存在一个证书信任链的验证环节。因为服务端向 CA 申请的证书一般不是根证书签发的，而是由中间证书机构签发。比如 thebyte.com.cn 证书，从下图可以看到，证书的层级有三级：

<div  align="center">
	<img src="../assets/https-5.png" width = "400"  align=center />
</div>

这种三级层级关系的证书会先由本地根证书验证中间证书，验证通过后再用中间证书验证服务端证书，全部验证通过后，则表示服务器证书是可信任的。

从整个流程来看，HTTPS 关键性在于根证书的安全性，如果根证书被修改了，那么信息传递也不再是“绝对”安全。理解了HTTPS的原理，那么我们继续下一节，看看有哪些可以优化的措施，以便让HTTPS请求更快。
