# 3.4.1  理解HTTPS流程

首先，HTTPS 的本质是解决信息传递的安全性。对于一个是 1 v 1的服务模型而言，使用对称加密就可以，只要保证密钥的安全，不让第三者知道，信息传输安全的问题就解决！

<div  align="center">
	<img src="../assets/https-1.png" width = "450"  align=center />
	<p>图：对称加密示例</p>
</div>

对称加密方式在 HTTP 服务场景下就出现问题了。 HTTP 服务模型是 1 v N 的方式。对称加密的核心是如何保证秘钥的安全性，在 1 v N 的模型下，这种方式等同没有加密。 

<div  align="center">
	<img src="../assets/https-2.png" width = "400"  align=center />
	<p>图：对称加密 1vN 模式</p>
</div>

为了解决秘钥安全性问题，我们可以进行改进使每个客户端使用不同的算法，并在中间增加一个协商的过程，用于双方协商对称加密算法。

<div  align="center">
	<img src="../assets/https-3.png" width = "400"  align=center />
	<p>图：对称加密模式下密钥协商</p>

</div>

HTTP 场景中增加协商过程可以解决对称加密算法或秘钥独立性问题。但协商过程是明文，密钥存在被截获的可能性。

解决这种问题，只能继续对协商过程的数据进行加密，对协商过程的隐私数据进行加密，就要采取另外一种加密方式了，如果仍然是对称加密，就会产生无限套娃的情况， 这里引入 非对称加密算法！

**非对称加密算法** 它有两个密钥：公钥、私钥。私钥加密的密文只能公钥解，公钥加密的密文只能私钥解。非对称加密大量的乘、模运算效率较低，而对称加密主要是位移类操作，效率较高。而 HTTP 传输信息量一般较大，在保证安全性的前提下，尽可能对内容提升加解密效率，所以在实现上，对通信内容进行对称加密，而这个对称加密的密钥则通过非对称加密得到。

具体则是：在协商流程中，通过随机数确定一个加密算法，然后使用公钥加密算法、密文等，服务器用私钥解密。

## 3.1.2 公钥如何传输给客户端

公钥由服务端下发给客户端，但又出现了上面的问题，如何保证公钥不被中间人截获？

<div  align="center">
	<img src="../assets/https-4.png" width = "400"  align=center />
</div>

## 3.1.3 引入 CA

CA 是 Certificate Authority 的缩写，意为证书认证机构。

如果选择服务端直接给客户端发送公钥证书，无论用什么方式中间被掉包的问题无法解决。用可信任三方的私钥对服务器公钥加密传给客户端。客户端用第三方公钥解密。这样做只要解决第三方的公钥就可以了。

服务端的证书是由 CA 签名，为制作成数字证书。 数字证书一般包括 公钥、持有者信息、证书认证机构（CA）的信息、过期信息...

CA机构可以通过颁发虚假证书的方式来监听用户的隐私，所以为了防止CA机构内部出现腐败等问题，人们提出了证书透明-CT机制（Certificate Transparency）来防止这种情况的发生。

CT机制要求CA机构每次颁发证书时都需要向`日志服务`提交证书详情，日志服务将SCT数据返回给CA机构，CA机构会将SCT数据加入证书的扩展，用户在进行TLS握手时除了要验证证书本身的合法性之外，还要进行CT检查来验证SCT数据的合法性，即需要使用日志服务的公钥来解析SCT数据中被日志服务私钥加密的数据。

`日志服务`采用了去中心化的区块链技术来实现，具体实现为`Merkle Tree`默克尔树，当CA机构试图修改任何一个记录时，都会引起树的`Root Hash`根哈希的改变。由于日志服务允许任何人访问和验证，所以只要哈希算法的安全性没有被打破，默克尔树就是安全的。

## 3.1.4 证书验证链

证书的验证过程中还存在一个证书信任链的问题，因为我们向 CA 申请的证书一般不是根证书签发的，而是由中间证书签发。比如 thebyte.com.cn 证书，从下图可以看到，证书的层级有三级：

<div  align="center">
	<img src="../assets/https-5.png" width = "400"  align=center />
</div>

对于这种三级层级关系的证书，会先由本地根证书验证中间证书，如果验证通过，则用中间证书验证 服务器证书，如果验证通过，则表示 服务器证书是可信人的。

从整个流程来看，HTTPS 关键性在于根证书的安全性，在一些地方要求安装根证书，实际上就是变相的中间人。

