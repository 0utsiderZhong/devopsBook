# 优化HTTP传输: 使用压缩

对传输内容进行压缩是提升HTTP服务效率的重要方式，如果使用Gzip压缩，一般一个100KB的文件压缩之后会变成30KB，这将极大减小传输时间。

## HTTP压缩的原理

所有的现代浏览器以及服务器都支持压缩技术，唯一需要协商的是所采用的压缩算法。

为了选择采用的压缩算法，HTTP客户端和服务器之间会使用主动协商机制，HTTP客户端发送 Accept-Encoding 首部，（其中包含它所支持的压缩算法，以及各自的优先级）服务器则从中选择一种，使用该算法对响应的消息主体进行压缩，并且发送 Content-Encoding 首部来告知HTTP客户端它选择了哪一种算法。

<div  align="center">
	<p>图：HTTP压缩协商流程</p>
	<img src="../assets/compress.png" width = "400"  align=center />
</div>

流行的无损压缩算法基本都依赖于 LZ77 和 Huffman 编码，在应用具体的 Gzip 或 Brotli 等方案之前我们先了解这两种压缩算法的基本原理。

## LZ77

LZ77压缩算法采用字典的方式进行压缩，是一个简单但十分高效的数据压缩算法。

其方式就是把数据中一些可以组织成短语(最长字符)的字符加入字典，然后再有相同字符出现采用标记来代替字典中的短语，如此通过标记代替多数重复出现的方式以进行压缩。

使用LZ77进行编码之后，用霍夫曼编码进一步压缩。

## Huffman 霍夫曼编码

霍夫曼编码是一种无损压缩算法，可以压缩图像、音频、文本。


## 在HTTP服务中应用Brotli

Brotli 是 Google 推出的开源无损压缩算法, 通过变种的 LZ77 算法、Huffman 编码以及二阶文本建模等方式进行数据压缩，与其他压缩算法相比，它有着更高的压缩效率，性能也比我们目前常见的 Gzip 高17-25%，侧重于HTTP压缩，可以帮我们高效的压缩网页中的各类文件。

与常见的通用压缩算法不同，Brotli使用一个预定义的120千字节字典。该字典包含超过13000个常用单词、短语和其他子字符串，这些来自一个文本和HTML文档的大型语料库。 

在这种预定义字典下，在LZ77压缩中字典中的一个词会作为一个整体被匹配，这种方式可以大大提升较小文件的压缩密度。

LinkedIn对一个JavaScript文件进行的压缩率对比，测试结果表明用Brotli压缩的 Javascript 文件比 Gzip 至少提升15％左右，

<div  align="center">
	<p>图：Brotli压缩效果对比</p>
	<img src="../assets/brotli.jpeg" width = "480"  align=center />
</div>