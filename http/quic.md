# 引入 QUIC 及实践

QUIC (Quick UDP Internet Connections) 是一种基于 UDP 封装的安全、可靠传输协议，他的目标是取代 TCP 并自包含 TLS 成为标准的安全传输协议。

下图是 QUIC 在协议栈中的位置，基于 QUIC 承载的 HTTP 协议进一步被标准化为 HTTP3。

<div  align="center">
	<img src="../assets/quic.png" width = "420"  align=center />
</div>

## QUIC 出现的背景

在 QUIC 之前， TCP 承载了 90% 多的互联网流量，似乎也没什么问题，那么为什么会出现革命者 QUIC 呢？ 

这主要是因为发展了几十年的 TCP 面临“协议僵化问题”，表现如下：

- 网络设备支持 TCP 的僵化，部分网络设备，如防火墙或者 NAT，对 TCP 引入了新的 OPTION, 有可能会被认为是攻击从而丢包，导致新特性无法在这些设备中工作
- HTTP + TLS 的首次握手还是需要花费多次 RTT，仍有优化空间
- 有序字节流引出的 队头阻塞（Head-of-line blocking），使得 HTTP2 多路复用能力大打折扣
- 基于TCP四元组确定一个连接，这种诞生于有线网络的设计，并不适合移动状态下的无线网络，IP地址频繁变动会导致 TCP 连接、TLS 会话反复握手

## QUIC的优势

QUIC协议的产生与今天的互联网应用场景和传输性能密切相关。随着海量移动设备推高互联网流量，越来越多的应用场景需要低延迟、高吞吐、应用QoS感知的网络传输等，原来的HTTP协议在提供流畅、高效的Web访问方面越来越难以满足应用需求。

这些问题也促使一款新的传输协议产生：将 TCP 最佳特性与 UDP 传输层结合起来。

**QUIC的一切特性始于“构建在UDP之上”**

这意味着可以不关心内核或者不用深入了解内核开发，也可以灵活地调整可靠传输机制和拥塞控制算法等，这极大地方便了各种对传输QoS敏感的应用，比如高 BDP 的网络、音视频传输等场景。

### 可扩展性

目前很难对 TCP 进行任何更改，并且 TCP 的 40 字节可选位几乎已完全被填满。TCP 没有任何版本协商字段位，而在合约中 QUIC 有 32 位。这为快速部署新版本以及供应商定义自己的专有版本提供了充足的空间。

### 可在用户空间实现

QUIC 可以在应用程序空间中实现，从而可以比在操作系统内核中实现的 TCP 更快地推出修改。这进一步增强了 QUIC 的可扩展性，允许快速的服务演进，甚至允许每天部署新功能。它还通过在上下文切换时涉及更少的开销来促进更高的响应能力

### 更快的连接

使用 HTTPS 时，TCP 连接需要“3 次握手”，然后在建立连接之前设置 TLS 协议。QUIC（基于 UDP）不需要 3 次握手，而且它在初始握手过程中交换了安全密钥，这使得建立加密连接的速度提高了一倍。

### 降低对丢包的敏感度

在 TCP 中，如果一个数据包被丢弃，所有后续的数据包都将被阻止，直到丢失的数据包被发送出去。这被称为“队头阻塞”，会显著增加延迟。相比之下，QUIC 使用多路复用的 HTTP2 连接方案，它支持并发的多个数据流。如果一个数据流出现错误，导致丢包，其他数据流将继续发送数据包而不会中断传输。

### 更适用移动设备

QUIC 提供从一个网络到另一个网络的平滑过渡。例如，如果你在家使用wifi 在手机上观看视频，走出家门离开 wifi 范围后连接将会切换到 LTE。在这种类似的情况下，TCP 会终止连接，并使用新的网络创建一个新的连接，可能会影响观看体验，而 QUIC 可以实现无缝切换。

### 提高安全性和隐私性

QUIC 在传输层中内置了加密功能，可以验证整个有效负载，包括报头。TCP 在报头中不包含加密，容易受到攻击。因此，QUIC 默认支持安全的 TLS，这意味着完整的端到端安全性。


