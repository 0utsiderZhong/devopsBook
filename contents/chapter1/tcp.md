# TCP优化实践

TCP是一个可靠的传输的协议，这也意味着TCP相关的参数会较为保守，而在内网环境、外网用户端等等网络环境、状态有很大的不同，比如内网就极少出现TCP重传现象。
特别是技术以及网络链路一直在发展升级，相应的去升级、调整部分内核参数，对服务会有很大的提升。本文也将从TCP连接、数据传输、实验性扩展三个方向讲解TCP优化思路以及相关的参数调整。

TCP是一个非常古老的协议，1973年诞生。那时候考虑的也挺简单，大哥大才刚出来，谁也想不到将来手机还能上网。

TCP连接标识设计上使用了四元组：{source ip, sport port, destination ip, destination port}，四个参数出现任何变化，连接就会断掉，这就导致了很大的局限性。前面说过移动设备漫游基站切换的问题。而基站是存在跨网段的，如果切换造成了IP的变化，那移动上层应用根本没办法维持连接。

这里不得不再提一下HTTP/3协议，引入了QUIC，拥塞控制模块又可在应用层封装（如Cubic、BBR使用更简单），而且连接用了ID，不会出现参数变化导致连接失效。
比TCP协议，更适合移动互联网。



内核参数我们主要关注两块：TCP内核参数、网络核心参数


### TCP内核参数 
/proc/sys/net/ipv4/ 存放着TCP参数的文件，如果想快速查看TCP所有相关的参数，也可以使用 sysctl命名

使用以下命令查看TCP相关内核参数

```
sysctl -a|grep net.ipv4.tcp

```

### 网络相关的内核参数

/proc/sys/net/core/ 中存放着Linux内核与网络层的交互相关的参数文件

```
sysctl -a|grep net.core
```


### 修改内核参数的方法

- 使用 echo value 方式直接追加到文件中。 如 echo "1" > /proc/sys/net/ipv4/tcp_syn_retries ，但是这种方式设备重启后，会恢复成默认值。
- 把参数添加到 /etc/sysctl.conf 中，然后执行 sysctl -p 使参数生效。这种方式是永久有效的。
- 使用systcl命令进行修改，例如修改SYN重传次数sysctl net.ipv4.tcp_syn_retries=n
