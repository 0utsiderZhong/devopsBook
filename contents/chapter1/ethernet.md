# Underlay和Overlay网络

随着云计算的普及，
SDN有点像云原生，很难对它的概念性进行解释，而Underlay/Overlay 或许是SDN从理念到实践并充分落地的一部分。

在数据中心网络虚拟化的场景下，在数据中心之内或者多个数据中心互联，首先建立一个底层的Underlay网络骨架，通过交换机和路由器将所有硬件单元相互连接。在这个Underlay网络内，通过运行IP协议如 BGP 来保证各个在网硬件单元之间的可达性。在完成Underlay网络构架之后，再通过部署SDN控制器的方式来对整网所有硬件资源进行调控编排，建立租户之间的虚拟网络连接并承载真正的用户流量。

通过将两种网络功能抽象成Underlay和Overlay网络，我们可以使得不同的网络专注于不同的功能。

比如Underlay网络来讲，可以更加注重承载能力，高可用性等特性，而Overlay网络则专注于实现各种最终用户所需的高级功能比如流量控制，服务链等等。



## Underlay 网络

Underlay网络就是传统IT基础设施网络，由交换机和路由器等设备组成，借助以太网协议、路由协议和VLAN协议等驱动，它还是Overlay网络的底层网络，为Overlay网络提供数据通信服务。


四层网关转发、VPC子网...理解这些技术，要懂点局域网知识， 而以太网(Ethernet)是目前最为普遍的局域网通信技术，包括办公室有线网、机房服务器网都是以太网。


以太网并不复杂：利用ARP协议获取其他主机MAC地址，再用交换机转发数据帧，基本就是以太网的通讯原理。


### "帧"（Frame）

帧分成两个部分：标头（Head）和数据（Data）。"标头"包含数据包的一些说明项，比如发送者、接受者、数据类型等等；"数据"则是数据包的具体内容。"标头"的长度，固定为18字节。"数据"的长度，最短为46字节，最长为1500字节。因此，整个"帧"最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送。


### ARP协议

ARP（Adress Resolution Protocol）地址解析协议，是根据IP地址获取物理地址的一个TCP/IP协议。
其基本原理是在每一台主机中设置一个ARP缓存表，存储该主机所在局域中其他主机、路由器的IP地址与MAC地址的映射关系。ARP协议通过在局域网内广播询问，单播回应的方式进行工作。

在发送数据前，设备会先查找ARP缓存表。如果缓存表中存在对方设备的MAC地址，则直接采用该MAC地址来封装帧，然后将帧发送出去。如果缓存表中不存在相应的信息，则通过发送ARP request报文来获得MAC地址。

<div  align="center">
	<p>图：ARP广播报文</p>
	<img src="/assets/arp.png" width = "600"  align=center />
</div>


### 交换机

交换机内部维护一张MAC地址表，记录着每一个MAC地址的设备，连接在哪一个端口中。发送方通过构造如图中数据包，在到达交换机时，交换机通过内部维护的MAC地址表找到对应的目标端口号。

<div  align="center">
	<p>图：交换机转发原理</p>
	<img src="/assets/exchanger.png" width = "600"  align=center />
</div>

### 路由器

交换机无法记录这种庞大的映射关系，而网络层的提出解决了这种问题。
网络层引入了一种新的地址方式，通过这种地址我们可以判断两台机器是否处于同一子网。同一子网则采用“广播式”发送，否则采用网络层“路由”方式发送。

在网络层中计算机有两种地址，无法修改的MAC以及管理员分配的IP地址，而为了判断两个IP是否处于同一子网，又引入了子网掩码。通过子网掩码分别与源IP、目标IP进行与运算，相等则在一个子网，数据通过交换机广播发送，不同则由路由器进行“路由”处理。

** 子网掩码判断 **

* 主机A：192.168.0.1 & 255.255.255.0  = 192.168.0.0   
* 主机B：192.168.0.2 & 255.255.255.0  = 192.168.0.0
* 主机C:  192.168.1.2 & 255.255.255.0  = 192.168.1.0


<div  align="center">
	<p>图：路由器工作原理</p>
	<img src="/assets/router.png" width = "650"  align=center />
</div>

主机A要发送C数据包，可以成功发送到了路由器了，路由器怎么知道从哪个端口发出最终到达目的地呢，这时候就需要一种路由表的东西。

不同于MAC地址表，路由表并不是一对一明确的关系。

目的的|下一跳|端口
:---|:--:|:--
192.168.0.0/24| 192.169.2.1 |0
192.168.0.254/32|		|1
192.168.0.1/24|		|1




一个小型的局域网可以用过交换机解决通信，稍大型的局域网可以通过组网及路由器通信，再大型的互联网呢，这涉及数亿台设备的互联，这就需要AS以及BGP路由概念了，互联网的通讯原理将在下个小节继续讲解。

