# 使用CDN对动静态内容加速

提升用户访问网络质量最有效的办法就是使用CDN。

CDN是内容分发网络的意思，主要的功能是将内容发布到离用户最近的服务器上，这样可以有效避免网络拥塞造成的服务质量下降。

事实上，如抖音、快手、腾讯视频类的流媒体平台，CDN带宽相关流量费用的支出绝对会占用相当大的比重，所以说理解CDN技术，结合服务自身情况，进行针对性的可用设计，才能有最好的保障服务。

## CDN概念性说明

CDN最大的作用是为静态内容提供加速服务，通过使用如Varnish、Squid等建立边缘节点本地化缓存服务给用户提供一个尽力而为的就近访问的能力，消除用户地域差异造成的网络质量不一致问题。

CDN通过部署大量的边缘节点解决用户访问的问题，边缘节点一般也称为 L1 Cache。 另外为了解决缓存穿透，避免大量回源引起的源站性能问题，CDN服务商又加入了 L2 Cache（中间服务层），L2 Cache将 L1 Cache的的穿透请求进行收敛，从而大幅提供命中率。

在CDN相关的服务质量中，通常关注命中率指标，过低的命中率会穿透L1、L2 Cache，严重会造成源站服务宕机问题。2022年春晚，爱奇艺直播出现了间隙性的直播不可用，就是大量的文件请求穿透边缘节点，造成源站过载无法提供服务。

## CDN的基本流程

在使用CDN后，用户访问一个静态文件，通常是这样的流程：

- DNS Lookup时，由全局负载均衡调度讲离用户最近的节点ip
- 用户将请求发给边缘服务器
- 如果边缘服务器没有命中缓存，则将请求代理给 CDN的 L2 Cache节点
- 如果L2 Cache也没有命中，则将请求继续代理给源站
- 源站接收请求，给L2 Cache返回，后续将返回逐层返回给用户。


## CDN的调度

在CDN的流程中提到了一个调度的概念，调度大概区分两种：基于Local DNS的静态调度、基于RTT的调度。

Local DNS的静态调度是CDN的权威DNS服务器，根据EDNS协议，获取用户IP地址 Local DNS来源，返回匹配的边缘节点VIP，基于RTT的调度依然先获取Local DNS的IP地址，将预调度、多个候选的CDN节点和Local DNS之间的RTT进行比较，选取RTT最小的节点返回给用户。


## 动态加速优化

上海到纽约是14000公里，按照光速，一个数据包从上海到纽约大约需要40ms，但实际情况在300ms以上。这是由于实际物理距离网络距离存在很多的差距，网络传输中间会有大量的BGP路由选路、丢包重传、链路的拥塞控制等等问题影响

如果您的服务面向全球用户，为了提升用户访问质量，除了在当地建设数据中心外，还可以使用动态加速的方案， 基于边缘节点进行服务动态加速，对跨国、跨运营商此类较差的网络环境下有较好的表现。

动态加速区别于静态加速是内容不可被缓存，实现动态加速的方案一般使用 网络专线优化、BGP选路优化、以及软件技术层面的优化。

### 网络专线

网络专线是一个虚拟线路的概念，对于运营商而言两个节点的距离，是根据成本规划的，并不是最短距离。建立专线就是依赖运营商通过流量转发、路由接入、带宽频次时隙租用等达到最短路径的效果。 如果在上海和纽约建立专线，一般情况下，延迟可以降低到120ms左右。（物理瓶颈无法突破）

### BGP的选路问题

实现动态加速非常重要的一个方式是路由优化，网络路由并不是最近原则选路，流量互通的不对等是BGP路由选路网络延迟大的主要原因，特别是跨境的路由转发，问题更大。

动态加速的路由优化利用CDN边缘节点组成的虚拟网络节点来进行优化的，通常使用7层代理转发改变 BGP 选路路径来进行优先选择。 路由优化大概的流程如下：

- 源站提供一个20KB以上的测试资源
- CDN会在源站周边选择一批候选CDN节点
- CDN边缘节点尝试下载测试资源，下载请求会首选发送到指定的候选CDN节点，多个候选CDN和边缘节点进行多路探索后选择最佳的路由线路进行优化

最佳线路通常会考量多个指标如丢包率、RTT、整体下载时间等等，这些指标用来判断线路是否最佳，这种路由探索一般是在数万台节点中动态进行，是一个很复杂的过程。


除了最重要的路由优化，根据前面TCP优化策略，CDN服务商也会有连接、传输等相关的策略调整，在应用层，像TLS1.3、ECC证书、QUIC协议等等相关对服务有提升的技术都有应用。（一些先进的压缩、路由、连接技术通常也是此类服务商有大量的投入，毕竟业务驱动技术改进嘛）


目前主流的CDN厂商都有这种技术，成熟的服务商如Akamai、Fastly、Cloudfront、Azure等等。

这些服务商在全球各区域部署了近百万台边缘设备，像Tiktok、Shopify、Amazon等等众多全球化的服务都有成功的应用。

<div  align="center">
	<p>图：边缘节点动态加速</p>
	<img src="/assets/edge.png" width = "600"  align=center />
</div>

## 动态加速效果

在我们的实际运营环境使用了Akamai对海外用户进行了加速服务，从抽样的数据看，整体连接速度提升了30%左右。对比海外用户访问香港节点、接入GSA加速网络，测使用https协议(后端直接返回http status：200  http body："succ")，  得到如下加速数据


区域|直连|Akamai加速|提升
:---|:--:|:--:|:--
Bangkok|0.58s|0.44|31%
jakarta|0.57s|0.44|31%
Kuala Lumpur|0.52s|0.38|36%
Taibei|0.51s|0.40|37%
Hanoi Bac Mai|0.54s|0.41|30%
Singapore|0.58s|0.39|48%
Hong Kong|0.38s|0.24|58%
Tokyo|0.60s|0.45s|32%
Surabaya|0.67s|0.52s|29%
Manila|0.46s|0.34s|36%

<div  align="center">
	<p>图：边缘节点动态加速</p>
	<img src="/assets/chapter1/akamai.png" width = "600"  align=center />
</div>、

在使用动态加速的情况下，香港直连平均 0.57s， Akamai加速 0.41s （Akamai提速 39%）, 用户请求低于0.5s, 在使用Akamai加速情况下，提升68.78%。用户请求高于0.6s,  直连模式下 较Akamai 高出21.38%。


















