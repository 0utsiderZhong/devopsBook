# 理解各类延迟

延迟是互联网中一个非常重要的概念，计算机硬件的发展、网络的发展（3G、4G到5G）、软件的发展很大程度都是为了解决各类延迟。

伯克利大学有个动态网页[^注1]，可以查看每年计算机中各类操作耗时、延迟的变化，我抽出了2020年的数据，做成了下面的表格。了解这些数字有助于设计和比较不同的解决方案以及衡量服务质量的标准。

在延迟数据的观察上，比较硬盘寻址和同个数据中心往返的延迟，这就意味着使用数据库服务（数据库通常把热数据放在缓存中）要比本地磁盘存储更有效率。再深一步Kafka、Leveldb等存储引擎设计也是利用了顺序读写快过随机读写的特性，只做追加写操作来达到最佳性能，这些都是基于延迟来设计的优化方案。


<center><p>表：计算机中各类延迟数据</p></center>

> 秒(s)、毫秒(ms)、微秒 (μs)、纳秒(ns)之间关系为：

> 1 s = $$10^{3}$$ms = $$10^{6}$$μs = $$10^{9}$$ns 


操作|延迟
:---|:--:|
L1 缓存查询| 1 ns
分支预测错误（Branch mispredict）| 3 ns
L2 缓存查询 | 4 ns
互斥锁/解锁 | 17 ns
在 1Gbps 的网络上发送 2KB | 44 ns
主存访问 | 100 ns
Zippy 压缩 1KB | 2,000 ns ≈ 2 μs
从内存顺序读取 1 MB | 3,000 ns ≈ 3 μs
SSD 随机读 | 16,000 ns  ≈ 16 μs
从 SSD 顺序读取 1 MB | 49,000 ns  ≈ 49 μs
同一个数据中心往返 | 500,000 ns  ≈ 0.5 ms
从磁盘顺序读取 1 MB | 825,000 ns  ≈ 0.8 ms
磁盘寻址 | 2,000,000 ns ≈ 2 ms
从美国发送到欧洲的数据包 | 150,000,000 ns ≈ 150 ms


## 网络延迟的标准

对于业务性的网络延迟统计标准我们可以用`首字节时间`和`RTT延迟`的方式进行，这两种方式都能比较准确的衡量网络质量。

### 首字节时间

首字节时间 (TTFB) 记录建立连接后首字节数据从服务器到达客户端所需的时间。TTFB 取决于两个因素：

- Server 服务器处理请求和创建响应所需的时间
- 响应返回到客户端所需的时间

因此，TTFB 同时衡量服务器处理时间和网络滞后，我们还可以按照感知 TTFB 衡量延迟，由于客户端计算机需要时间来进一步处理响应，因此感知 TTFB 比实际 TTFB 长。

### RTT延迟

往返时间 (RTT) 是客户端发送请求并从服务器接收响应所需的时间, 网络延迟会导致往返延迟并增加 RTT。但是要注意因为网络数据转发是动态的，路径也会发生变化，RTT并不能绝对说明问题。 

## 海外延迟数据参考 

网络延迟50ms以下及左右可以提供较好的服务，如果在100ms以上，加上DNS、TCP连接、后端服务计算通常在用户端延迟会达到300ms+。 

到真实的用户场景，如果是动态服务，本身有一定的时间处理加上接口数据大小、网络抖动等因素会加剧延迟的增大，会让P90整体延迟在700ms以上，这时候就需要注意这个指标了。


爱奇艺在海外业务在建设初期，收集了部分用户端到网络服务端的延迟数据，笔者汇成了以下表格，以供读者参考 （注：数据统计于2019年末，单条统计数大于10,000）

| 国家/地区（client） | 测试节点1（香港 server1） | 测试节点2（北京 server2）|
| :--- | :---- | :---- |
|新加坡|34ms|202ms|
|香港|3ms|94ms|
|泰国|52ms|132ms|
|越南|32ms|429ms|
|柬埔寨|30ms|75ms|
|台湾|30ms|151ms|
|马来西亚|38ms|209ms|
|菲律宾|18ms|64ms|
|印度尼西亚|44ms|187ms|
|美国|196ms|256ms|
|加拿大|205ms|236ms|
|温哥华|137ms|209ms|
|丹佛|204ms|176ms|
|华盛顿|223ms|244ms|
|洛杉矶|149ms|149ms|
|纽约|185ms|226ms|
|旧金山|155ms|185ms|
|波特兰|157ms|153ms|
|蒙特利尔|206ms|233ms|
|魁北克|197ms|207ms|
|休斯敦|208ms|193ms|



[^注1]: https://colin-scott.github.io/personal_website/research/interactive_latency.html