# 海外用户的网络延迟情况

对于国内的服务，只要关注移动、联通、电信三大运营商就可以服务好大部分用户，情况换到面向多个国家/地区的海外业务，问题复杂多了。我们要面临复杂的运营商环境、复杂的跨国骨干链路、大带宽时延等种种问题。

解决这些问题最好的办法建设当地的数据中心、部署大量的边缘节点、使用CDN技术等，尽可能的靠近用户，但这些方式会产生大量的成本，看各类流媒体企业最大的技术成本都是CDN。除了就近服务外，像Google、YouTube、Cloudflare等等互联网厂商都在想尽办法用技术手段提升效率，为此也崔生了如QUIC、KCP、BBR等等链路优化技术, 在下个章节也将讲解爱奇艺在数据链路以及边缘节点方面的优化实践。


### 网络延迟的标准

网络延迟的统计标准我们可以用首字节时间和RTT延迟的方式进行，这两种方式都能比较准确的衡量网络质量。

#### 首字节时间

首字节时间 (TTFB) 记录在建立连接后首字节数据从服务器到达客户端所需的时间。TTFB 取决于两个因素：

- Web 服务器处理请求和创建响应所需的时间
- 响应返回到客户端所需的时间

因此，TTFB 同时衡量服务器处理时间和网络滞后，我们还可以按照感知 TTFB 衡量延迟，由于客户端计算机需要时间来进一步处理响应，因此感知 TTFB 比实际 TTFB 长。

#### RTT延迟

往返时间 (RTT) 是客户端发送请求并从服务器接收响应所需的时间。网络延迟会导致往返延迟并增加 RTT。但是，通过网络监控工具进行的所有 RTT 衡量都是部分指标，因为数据在客户端和服务器之间传输时可能会通过不同的网络路径传输。 



### 海外延迟数据参考 

网络延迟50ms以下及左右可以提供较好的服务，如果在100ms以上，加上DNS、TCP连接、后端服务计算通常在用户端延迟会达到300ms+。 到真是的用户场景，如果是动态服务，本身有一定的时间处理加上接口数据大小、网络抖动等因素会加剧延迟的增大，会让P90整体延迟在700ms以上，这时候就需要注意这个指标了。


爱奇艺在海外业务在建设初期，收集了部分用户端到网络服务端的延迟数据，我汇成了以下表格，以供读者参考 （注：数据统计于2019年末，单条统计数大于10,000）

| 国家/地区（client） | 测试节点1（香港 server1） | 测试节点2（北京 server2）|
| :--- | :---- | :---- |
|新加坡|34ms|202ms|
|香港|3ms|94ms|
|泰国|52ms|132ms|
|越南|32ms|429ms|
|柬埔寨|30ms|75ms|
|台湾|30ms|151ms|
|马来西亚|38ms|209ms|
|菲律宾|18ms|64ms|
|印度尼西亚|44ms|187ms|
|美国|196ms|256ms|
|加拿大|205ms|236ms|
|温哥华|137ms|209ms|
|丹佛|204ms|176ms|
|华盛顿|223ms|244ms|
|洛杉矶|149ms|149ms|
|纽约|185ms|226ms|
|旧金山|155ms|185ms|
|波特兰|157ms|153ms|
|蒙特利尔|206ms|233ms|
|魁北克|197ms|207ms|
|休斯敦|208ms|193ms|


















